# Экзамен. SQL

## Оглавление

1. [Что такое SQL?](#1-Что-такое-SQL)
2. [Что такое DML и DDL?](#2-Что-такое-DML-и-DDL)
3. [Что такое первичный ключ?](#3-Что-такое-первичный-ключ)
4. [Что такое внешний ключ?](#4-Что-такое-внешний-ключ)
5. [Какие виды связей между таблицами существуют и как они организуются?](#5-Какие-виды-связей-между-таблицами-существуют-и-как-они-организуются)
6. [Напишите как вставить, удалить, обновить данные в(из) таблицу(ы).](#6-Напишите-как-вставить-удалить-обновить-данные-в(из)-таблицу(ы).)
7. [Что такое нормализация БД?](#7-Что-такое-нормализация-БД)
8. [Что такое денормализация БД? Для чего она нужна?](#8-Что-такое-денормализация-БД-Для-чего-она-нужна)
9. [Что такое кластерный и некластерный индексы?](#9-Что-такое-кластерный-и-некластерный-индексы)
10. [Какие типы соединений (join) таблиц существуют? В чем их разница?](#10-Какие-типы-соединений-join-таблиц-существуют-В-чем-их-разница)
11. [Что такое SQL курсор?](#11-Что-такое-SQL-курсор)
12. [Опишите шаги по созданию и использованию курсора.](#12-Опишите-шаги-по-созданию-и-использованию-курсора)
13. [Что такое транзакция?](#13-Что-такое-транзакция)
14. [Что такое триггер? Какие типы триггеров Вы знаете?](#14-Что-такое-триггер-Какие-типы-триггеров-Вы-знаете)
15. [В чем разница между where и having?](#15-В-чем-разница-между-where-и-having)
16. [Что такое подзапрос (sub-query)?](#16-Что-такое-подзапрос-sub-query)
17. [Что такое union?](#17-Что-такое-union)
18. [Что такое group by?](#18-Что-такое-group-by)
19. [Что такое хранимые процедуры?](#19-Что-такое-хранимые-процедуры)
20. [Что такое view(Представление)?](#20-Что-такое-view-Представление)
21. [Что такое JDBC?](#21-Что-такое-JDBC)
22. [Что нужно для работы с той или иной БД?](#22-Что-нужно-для-работы-с-той-или-иной-БД)
23. [Как зарегистрировать драйвер?](#23-Как-зарегистрировать-драйвер)
24. [Как получить Connection?](#24-Как-получить-Connection)
25. [Что такое Statement, PrepareStatement? В чем разница между ними?](#25-Что-такое-Statement-PrepareStatement-В-чем-разница-между-ними)
26. [Что такое ResultSet?](#26-Что-такое-ResultSet)
27. [В чем разница между методами execute, executeUpdate, executeQueury?](#27-В-чем-разница-между-методами-execute-executeUpdate-executeQueury)
28. [Можно ли использовать возвращаемое значение execute() для проверки, что что-то обновилось?](#28-Можно-ли-использовать-возвращаемое-значение-execute-для-проверки-что-что-то-обновилось)
29. [Как получить при вставке сгенерированные ключи? Как это сделать на чистом sql?](#29-Как-получить-при-вставке-сгенерированные-ключи-Как-это-сделать-на-чистом-sql)
30. [Для чего используется конструкция try-with-resources?](#30-Для-чего-используется-конструкция-try-with-resources)

## 1 Что такое SQL?

SQL - Structured Query Language - структурированный язык запросов - специальный язык для работы с базами данных. Набор
команд, который используется для работы с БД, называется _скриптом_.

[К оглавлению &#8593;](#Оглавление)

## 2 Что такое DML и DDL?

DML - Data Manipulation Library - операции над самими данными (создание, получение, удаление, обновление самих данных)  
DDL - Data Declaration Library - операции над структурой данных (создание, удаление, изменение и т.д таблиц и баз
данных)

[К оглавлению &#8593;](#Оглавление)

## 3 Что такое первичный ключ?

Primary Key - идентификатор записи в таблице (запись - это строка в таблице) - это некоторый атрибут или несколько
атрибутов, которые однозначно характеризуют запись -> по идентификатору можно однозначно идентифицировать запись, то
есть найти её. Чаще всего в качестве идентификатора берут число, так как по числам проще искать и их легко представить.

[К оглавлению &#8593;](#Оглавление)

## 4 Что такое внешний ключ?

Foreign Key - связь с другой таблицей, то есть ссылка на какой-то столбец другой таблицы.

[К оглавлению &#8593;](#Оглавление)

## 5 Какие виды связей между таблицами существуют и как они организуются?

Существуют:

+ many-to-one - любому значению атрибута А соответствует 0, 1 или несколько значений атрибута В.  
  Для связи между собой таблиц используется внешний ключ - атрибут таблицы, который содержит значения из другой таблицы,
  что позволяет связать записи между собой. Для этого используется ключевое слово REFERENCES. Это значит, что значения
  данного столбца - значения связываемой таблицы.

```sql
 create table position
 (
     id   serial primary key,
     name varchar(255)
 );
create table employees
(
    id          serial primary key,
    name        varchar(255),
    position_id int references position (id)
);
insert into position(name)
values ('programmer');
insert into employees(name, position_id)
VALUES ('Ivan', 1);
```

+ many-to-many -любому значению атрибута А соответствует 0, 1 или несколько значений атрибута В, и любому значению
  атрибута В соответствует 0, 1 или несколько значение атрибута А.  
  Организуется с помощью вспомогательной таблицы, в которой идет двойное применение REFERENCES.

```sql
 create table students
 (
     id   serial primary key,
     name varchar(255)
 );

create table courses
(
    id   serial primary key,
    name varchar(255)
);

create table students_courses
(
    id         serial primary key,
    student_id int references students (id),
    course_id  int references courses (id)
);
```

+ one-to-one - любому значению атрибута А соответствует только одно значение атрибута В, и наоборот.  
  Есть однонаправленная (unidirectional) и двунаправленная (bidirectional)

Однонаправленная:

```sql
create table passport
(
    id     serial primary key,
    seria  int,
    number int
);

create table people
(
    id          serial primary key,
    name        varchar(255),
    passport_id int references passport (id) unique
);
```

Рядом с внешним ключом стоит unique. Это значит, что данное значение уникально среди всех записей данного столбца. Без
этого ограничения(constraint) мы получим связь many-to-one. Теперь по записи в таблице людей мы можем перейти в таблицу
паспорта для уточнения данных.

Двунаправленная:

```sql
create table passport
(
    id     serial primary key,
    seria  int,
    number int
);

create table people
(
    id   serial primary key,
    name varchar(255)
);

create table passport_people
(
    id          serial primary key,
    passport_id int references passport (id) unique,
    people_id   int references people (id) unique
);
```

Используются ограничения на внешние ключи unique, иначе мы получим связь many-to-many.

[К оглавлению &#8593;](#Оглавление)

## 6 Опишите как вставить, удалить, обновить данные в(из) таблицу(ы).

Для вставки данных в таблицу используется команда _INSERT_:

```sql
INSERT INTO table_name(attr1, attrN)
VALUES (attr1_value, attrN_value);
```

Для удаления данных используется команда _DELETE_:

```sql
DELETE
FROM table_name;
```

Для обновления данных используется команда _UPDATE_:

```sql
UPDATE table_name
SET attr1 = attr1_value,
    attrN = attrN_value;
```

[К оглавлению &#8593;](#Оглавление)

## 7 Что такое нормализация БД?

Нормализация — это процесс организации данных в базе данных, включающий создание таблиц и установление отношений между
ними в соответствии с правилами, которые обеспечивают защиту данных и делают базу данных более гибкой, устраняя
избыточность и несогласованные зависимости.

Нормализация предназначена для приведения структуры базы данных к виду, обеспечивающему минимальную логическую
избыточность, и не имеет целью уменьшение или увеличение производительности работы или же уменьшение, или увеличение
физического объёма базы данных. Конечной целью нормализации является уменьшение потенциальной противоречивости хранимой
в базе данных информации.

[К оглавлению &#8593;](#Оглавление)

## 8 Что такое денормализация БД? Для чего она нужна?

Денормализация базы данных — это процесс осознанного приведения базы данных к виду, в котором она не будет
соответствовать правилам нормализации. Обычно это необходимо для повышения производительности и скорости извлечения
данных, за счет увеличения избыточности данных.

[К оглавлению &#8593;](#Оглавление)

## 9 Что такое кластерный и некластерный индексы?

Индекс (index) — объект базы данных, создаваемый с целью повышения производительности выборки данных.

По воздействию на источник данных разделяют:

+ кластерный индекс - при определении в наборе данных физическое расположение данных перестраивается в соответствии со
  структурой индекса. Логическая структура набора данных в этом случае представляет собой скорее словарь, чем индекс.
  Данные в словаре физически упорядочены, например по алфавиту. Кластерные индексы могут дать существенное увеличение
  производительности поиска данных даже по сравнению с обычными индексами. Увеличение производительности особенно
  заметно при работе с последовательными данными.
+ некластерный индекс — наиболее типичные представители семейства индексов. В отличие от кластерных, они не
  перестраивают физическую структуру набора данных, а лишь организуют ссылки на соответствующие записи. Для
  идентификации нужной записи в наборе данных некластерный индекс организует специальные указатели, включающие в себя:
  информацию об идентификационном номере файла, в котором хранится запись; идентификационный номер страницы
  соответствующих данных; номер искомой записи на соответствующей странице; содержимое столбца.

  [К оглавлению &#8593;](#Оглавление)

## 10 Какие типы соединений (join) таблиц существуют? В чем их разница?

+ inner: берется запись из таблицы табл1 и берется запись из таблицы табл2, если значения по столбцам этих записей
  удовлетворяют условию, прописанному через on, то конечная запись (запись из значений столбцов табл1 и табл2) попадает
  в результат.
+ outer: берется исходная таблица и для каждой ее записи находится запись, которая бы удовлетворяла условию. Если она не
  будет найдена, то по столбцам будут стоять null.
+ cross: результатом является декартово множество, т.е. все пары элементов. Например, если в таблице 1 N записей, а в
  таблице 2 M записей, то мы получим в результате N * M записей.

[К огавлению &#8593;](#Оглавление)

## 11 Что такое SQL курсор?

Курсор в SQL – это область в памяти базы данных, которая предназначена для хранения последнего оператора SQL. Если
текущий оператор – запрос к базе данных, в памяти сохраняется и строка данных запроса, называемая текущим значением, или
текущей строкой курсора. Указанная область в памяти поименована и доступна для прикладных программ.

[К огавлению &#8593;](#Оглавление)

## 12 Опишите шаги по созданию и использованию курсора.

В соответствии со стандартом SQL при работе с курсорами можно выделить следующие основные действия:

+ создание или объявление курсора;
+ открытие курсора, т.е. наполнение его данными, которые сохраняются в многоуровневой памяти;
+ выборка из курсора и изменение с его помощью строк данных;
+ закрытие курсора, после чего он становится недоступным для пользовательских программ;
+ освобождение курсора, т.е. удаление курсора как объекта, поскольку его закрытие необязательно освобождает
  ассоциированную с ним память.

[К огавлению &#8593;](#Оглавление)

## 13 Что такое транзакция?

Транзакция - это воздействие на базу данных, переводящее её из одного целостного состояния в другое и выражаемое в
изменении данных, хранящихся в базе данных.

[К огавлению &#8593;](#Оглавление)

## 14 Что такое триггер? Какие типы триггеров Вы знаете?

Триггеры — это части кода, запускаемые автоматически и основанные на каком-либо действии или событии в таблице базы
данных.

Триггеры могут применять в таблице во время выполнения операторов INSERT, UPDATE или DELETE, а затем работать или перед,
или после этих действий. Некоторые СУБД также позволяют работать триггерам на уровне оператора или на уровне каждой
строки данных во время ее изменения.

[К огавлению &#8593;](#Оглавление)

## 15 В чем разница между where и having?

where нельзя использовать с агрегатными функциями. Для этих целей специально служит оператор having. Применяется он
аналогично where, только в нем обязательно должна быть агрегатная функция.

[К огавлению &#8593;](#Оглавление)

## 16 Что такое подзапрос (sub-query)?

Подзапрос представляет собой оператор SELECT, вложенный в тело другого оператора.

[К огавлению &#8593;](#Оглавление)

## 17 Что такое union?

union - операция, применяемая для объединения двух наборов строк, возвращаемых SQL-запросами.

[К огавлению &#8593;](#Оглавление)

## 18 Что такое group by?

group by - разделение исходных данных на группы по какому-либо признаку.

[К огавлению &#8593;](#Оглавление)

## 19 Что такое хранимые процедуры?

Хранимая процедура — объект базы данных, представляющий собой набор SQL-инструкций, который хранится на сервере.

[К огавлению &#8593;](#Оглавление)

## 20 Что такое view(Представление)?

Представление (VIEW) — объект базы данных, являющийся результатом выполнения запроса к базе данных, определенного с
помощью оператора SELECT, в момент обращения к представлению. Представления иногда называют «виртуальными таблицами».
Такое название связано с тем, что представление доступно для пользователя как таблица, но само оно не содержит данных, а
извлекает их из таблиц в момент обращения к нему.

[К огавлению &#8593;](#Оглавление)

## 21 Что такое JDBC?

JDBC – это API, т.е. набор вспомогательных классов, которое позволяет работать с базами данных. Причем JDBC
предоставляет единый интерфейс для работы с ними, ведь бывают различные базы данных.

[К огавлению &#8593;](#Оглавление)

## 22 Что нужно для работы с той или иной БД?

Для работы с той или иной БД нужен _драйвер_. Драйвер позволяет поддерживать подключения, выполнять запросы и т.д. Для
каждой БД есть свой драйвер. Чтобы добавить драйвер в проект необходимо добавить зависимость на этот самый драйвер.

[К огавлению &#8593;](#Оглавление)

## 23 Как зарегистрировать драйвер?

Properties cfg;   
Class.forName(cfg.getProperty("driver"));

[К огавлению &#8593;](#Оглавление)

## 24 Как получить Connection?

Properties cfg;  
Connection connection = DriverManager.getConnection(cfg.getProperty("url"), cfg.getProperty("username"),
cfg.getProperty("password"));

[К огавлению &#8593;](#Оглавление)

## 25 Что такое Statement, PrepareStatement? В чем разница между ними?

Statement, PrepareStatement - интерфейсы для исполнения операций в БД.  
Отличием PrepareStatement от Statement является то, что он используется для выполнения параметризованных SQL-запросов.

Рассмотрим интерфейс Statement:

```java
        try(Statement statement=connection.createStatement()){
        String sql=String.format(
        "create table if not exists demo_table(%s, %s);",
        "id serial primary key",
        "name text"
        );
        statement.execute(sql);
        }
```

Создали объект Statement для запроса. Для его выполнения существуют 3 метода: execute(), executeUpdate(), executeQuery()
. При их вызове мы должны передать в качестве аргумента SQL - запрос.

Рассмотрим интерфейс PreparedStatement:

```java
 try(PreparedStatement statement=
        connection.prepareStatement("insert into cities(name, population) values (?, ?)")){
        statement.setString(1,city.getName());
        statement.setInt(2,city.getPopulation());
        statement.execute();
        }catch(Exception e){
        e.printStackTrace();
        }
```

Основная особенность объекта PrepareStatement заключается в том, что при создании ему передается SQL - запрос с
параметрами. 
+ Параметры, т.е. места куда будут подставляться аргументы, обозначаются «?»
+ Для подстановки аргументов используются методы вида “setТип(позиция, аргумент)”
+ Позиция аргумента считается как его порядковый номер, а не как индекс, т.е. позиции аргументов начинаются с 1

[К огавлению &#8593;](#Оглавление)

## 26 Что такое ResultSet?

ResultSet - это объект, который позволяет пройтись по результатам запроса

[К огавлению &#8593;](#Оглавление)

## 27 В чем разница между методами execute, executeUpdate, executeQueury?

+ executeUpdate()

Данный метод используется как для выполнения операторов управления данными (DML - операторы), например INSERT, UPDATE
или DELETE, так и для операторов определения структуры базы данных (DDL - операторы), например CREATE TABLE, DROP TABLE.
Возвращает int – количество affected строк, т.е. количество строк на которые оказал влияние запрос. Для операторов,
которые не манипулируют строками, таких как CREATE TABLE или DROP TABLE, возвращаемое значение executeUpdate всегда
равно нулю.

+ executeQuery()

Как правило, этот метод используется для выполнения операции SELECT и возвращает объект ResultSet, который позволяет
пройтись по результатам запроса.

+ execute()

Используется для выполнения любых команд. Возвращает true, если результатом выполнения является ResultSet (то есть был
выполнен SELECT запрос), или false, если результатом является int (количество изменённых строк). Получить ResultSet или
количество строк мы можем с помощью последующего вызова getUpdateCount() или getResultSet().

```java
statement.execute(sql);
        int count=statement.getUpdateCount();
        /* эквивалентно */
        int count=statement.executeUpdate(sql);

        statement.execute(sql);
        ResultSet result=statement.getResultSet();
        /* эквивалентно */
        ResultSet result=statement.executeQuery(sql);
```

[К оглавлению &#8593;](#Оглавление)

## 28 Можно ли использовать возвращаемое значение execute() для проверки, что что-то обновилось?

Да, можно, с помощью последующего вызова statement.getUpdateCount() или statement.getResultSet().

[К огавлению &#8593;](#Оглавление)

## 29 Как получить при вставке сгенерированные ключи? Как это сделать на чистом sql?

Нужно при создании PrepareStatement вторым аргументом передать Statement.RETURN_GENERATED_KEYS.

[К огавлению &#8593;](#Оглавление)

## 30 Для чего используется конструкция try-with-resources?

Так как многие объекты jdbc реализуют Autocloseable, их нужно использовать с try-with-resources.

Данная конструкция(try-with-resources) позволяет использовать блок try-catch, не заботясь о закрытии ресурсов,
используемых в данном сегменте кода. Ресурсы объявляются в скобках сразу после try, а компилятор уже сам неявно создаёт
секцию finally, в которой и происходит закрытие без участия разработчика. Конструкция является так называемым
«синтаксическим сахаром» и создана для облегчения жизни программиста. Под ресурсами подразумеваются сущности,
реализующие интерфейс java.lang.Autocloseable. Общий вид конструкции выглядит следующим образом

```java
try(тут объявляются ресурсы){
        ......
        }catch(Exception ex){
        ...
        }finally{
        ...
        } 
```

Стоит заметить, что блоки catch и явный finally выполняются уже после того, как закрываются ресурсы в неявном finally.

[К оглавлению &#8593;](#Оглавление)